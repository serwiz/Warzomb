<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Page principale</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="style.css" media="screen" />

    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.4.1/firebase-auth.js"></script>
  </head>
  <body>


    <!-- Javascript files -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="fireBase.js"></script>
    <script src="index.js"></script>
    <script src="init.js"></script>
    <script src="fireBase.js"></script>
    <script src="index.js"></script>
    <script>
      /** allow us to check if a user is still connected */
      var firebase = app_fireBase;
      var name = null;
      var user = firebase.auth().currentUser;
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          name = user.displayName;
        } else {
          name = "anonymous";
          console.log("no user detected");
        }
        drawName();
      });
    </script>

    <!-- html elements -->

    <!-- game part -->
    <div class="side_game"></div>
    <div class="main">
      <div class="canvas-container">
        <canvas id="game_zone-ui-left" width="300" height="512"></canvas>
        <canvas id="game_zone" width="512" height="512"></canvas>
        <canvas id="game_zone-ui-right" width="300" height="512"></canvas>
      </div>
    </div>

    <!-- chat part-->
    <div class="box">
      <div>Chat</div>
      <div class="chatBox" id="chat-text"></div>
      <form id="chat-form">
        <input
          id="chat-input"
          type="text"
          style="width:30%;height:30px;"
          autocomplete="off"
        />
        <input class="btn" type="submit" value="Send" />
      </form>
    </div>
    <script>
      var typing = false;
      var socket = io();
      //////////////////////////////////////////////////////////////
      /** charging sprites */
      /** will be replace by bdd loads */
      var character = new Image();
      character.src = "/tileset/images/character";
      var ennemy = new Image();
      ennemy.src = "tileset/images/ennemy";
      var fireball = new Image();
      fireball.src = "tileset/images/fireball";
      var map = new Image();
      map.src = "/tileset/images/map1";

      //////////////////////////////////////////////////////////////
      /** game */
      var game = document.getElementById("game_zone").getContext("2d");
      var left_game = document
        .getElementById("game_zone-ui-left")
        .getContext("2d");
      game.font = "30px Arial";
      left_game.font = "20px Arial";
       var right_game = document
        .getElementById("game_zone-ui-right")
        .getContext("2d");
      right_game.font = "20px Arial";

      /**
       * draw the players and the projectiles
       * @param {list} players - list of players
       * @param {list} players - list of projectiles
       */
      function drawObjects(players, projectiles, ennemies) {
        // players
        for (var i in players) {
          // hpBar
          var hpBar = (30 * players[i].life) / players[i].maxLife;
          game.fillStyle = "red";
          game.fillRect(players[i].x - hpBar / 2, players[i].y - 40, hpBar, 4);

          // player sprite
          var width = character.width * 2;
          var height = character.height * 2;
          game.drawImage(
            character,
            0,
            0,
            character.width,
            character.height,
            players[i].x - width / 2,
            players[i].y - height / 2,
            width,
            height
          );
        }

        // projectiles
        for (var i in projectiles)
          game.drawImage(
            fireball,
            0,
            0,
            fireball.width,
            fireball.height,
            projectiles[i].x - 5,
            projectiles[i].y - 5,
            width - 10,
            height - 10
          );

        // ennemies
        for (var i in ennemies) {
          var hpBar = (30 * ennemies[i].life) / ennemies[i].maxLife;
          game.fillRect(
            ennemies[i].x - hpBar / 8,
            ennemies[i].y - 20,
            hpBar,
            4
          );
          game.drawImage(
            ennemy,
            0,
            0,
            ennemy.width,
            ennemy.height,
            ennemies[i].x - width / 2,
            ennemies[i].y - height / 2,
            width * 2,
            height * 2
          );
        }
      }

      /**
       * draw the HuD, for the moment only the score is displayed
       */
      function drawHud() {
        left_game.fillStyle = "black";
        left_game.fillText(
          clientPlayer.list[playerId].frag +
            "/" +
            clientPlayer.list[playerId].death +
            "/" +
            clientPlayer.list[playerId].score,
          0,
          40
        );
        
        right_game.fillStyle = "black";
        right_game.fillText("HP: " +
          clientPlayer.list[playerId].life + "/" + clientPlayer.list[playerId].maxLife,
          0,
          20
        );
      }

      function drawName() {
        left_game.fillStyle = "black";
        left_game.fillText(name, 0, 20);
      }

      //////////////////////////////////////////////////
      /** chat */
      var chatText = document.getElementById("chat-text");
      var chatInput = document.getElementById("chat-input");
      var chatForm = document.getElementById("chat-form");

      /**
       * When receiving the call, print the message
       * @param {String} data - message to print
       */
      socket.on("printMessage", function(data) {
        console.log("got a chat message");
        chatText.innerHTML += '<div class="chatCell">' + data + "</div>";
        chatText.scrollTop = chatText.scrollHeight;
      });

      /**
       * When sending a message, emit a call to the server
       * @param {event} e - submit event
       */
      chatForm.onsubmit = function(e) {
        //prevent the form from refreshing the page
        e.preventDefault();
        //ask to send the message to all the players
        socket.emit("sendMessage", chatInput.value);
        chatInput.value = "";
      };

      ///////////////////////////////////////////////////

      /**
       * When receiving the call, initialize the objects
       * @param {list} data - list of players and projectiles to create on the client side
       */
      socket.on("init", function(data) {
        if (data.Id) playerId = data.Id;

        for (var i = 0; i < data.player.length; i++) {
          clientPlayer(data.player[i]);
        }
        for (var i = 0; i < data.projectile.length; i++) {
          clientProjectile(data.projectile[i]);
        }
        for (var i = 0; i < data.ennemy.length; i++) {
          clientEnnemy(data.ennemy[i]);
        }
      });

      /**
       * When receiving the call, update info
       *  @param {list} data - list of players and projectiles to create on the client side
       */
      socket.on("update", function(data) {
        for (var i = 0; i < data.player.length; i++) {
          var player = clientPlayer.list[data.player[i].id];
          if (player) {
            if (data.player[i].x !== undefined) player.x = data.player[i].x;
            if (data.player[i].y !== undefined) player.y = data.player[i].y;
            if (data.player[i].hp !== undefined)
              player.life = data.player[i].hp;
            if (data.player[i].score !== undefined)
              player.score = data.player[i].score;
            if (data.player[i].death !== undefined)
              player.death = data.player[i].death;
            if (data.player[i].frag !== undefined)
              player.frag = data.player[i].frag;
          }
        }
        for (var i = 0; i < data.projectile.length; i++) {
          var p = clientProjectile.list[data.projectile[i].id];
          if (p) {
            if (data.projectile[i].x !== undefined) p.x = data.projectile[i].x;
            if (data.projectile[i].y !== undefined) p.y = data.projectile[i].y;
          }
        }
        for (var i = 0; i < data.ennemy.length; i++) {
          var e = clientEnnemy.list[data.ennemy[i].id];
          if (e) {
            if (data.ennemy[i].x !== undefined) e.x = data.ennemy[i].x;
            if (data.ennemy[i].y !== undefined) e.y = data.ennemy[i].y;
            if (data.ennemy[i].hp !== undefined) e.life = data.ennemy[i].hp;
          }
        }
      });

      /**
       * When receiving the call, delete info
       *  @param {list} data - list of players and projectiles to create on the client side
       */
      socket.on("delete", function(data) {
        for (var i = 0; i < data.player.length; i++) {
          delete clientPlayer.list[data.player[i]];
        }
        for (var i = 0; i < data.projectile.length; i++) {
          delete clientProjectile.list[data.projectile[i]];
        }
        for (var i = 0; i < data.ennemy.length; i++) {
          delete clientEnnemy.list[data.ennemy[i]];
        }
      });

      //////////////////////////////////////////////////////////
      /**
       * Update the display
       */
      setInterval(function() {
        if (!playerId) return;
        // map
        game.clearRect(0, 0, 512, 512);
        game.drawImage(map, 0, 0);
        if (clientPlayer.list[playerId].score !== lastScore || clientPlayer.list[playerId].frag !== lastFrag ||clientPlayer.list[playerId].death !== lastDeath || clientPlayer.list[playerId].life !== lastLife) {
          left_game.clearRect(0, 0, 300, 500);
          right_game.clearRect(0, 0, 300, 500);
          lastScore = clientPlayer.list[playerId].score;
          lastFrag = clientPlayer.list[playerId].frag;
          lastDeath = clientPlayer.list[playerId].death;
          lastLife = clientPlayer.list[playerId].life;
          drawHud();
          drawName();
        }
        drawObjects(
          clientPlayer.list,
          clientProjectile.list,
          clientEnnemy.list
        );
      }, 1000 / 60); // 1000ms = 1s

      ////////////////////////////////////////////////////////
      /** events handler */

      /**
       * When receiving the call, do one of the actions according to the event's value
       *  @param {event} event - key pressed event
       */
      document.onkeydown = function(event) {
        if (typing) {
          event.prevenDefault();
          return false;
        }
        if (event.keyCode === 68)
          //d
          socket.emit("keyPress", { inputId: "right", state: true });
        else if (event.keyCode === 83)
          //s
          socket.emit("keyPress", { inputId: "down", state: true });
        else if (event.keyCode === 81)
          //q
          socket.emit("keyPress", { inputId: "left", state: true });
        else if (event.keyCode === 90)
          // z
          socket.emit("keyPress", { inputId: "up", state: true });
        else if (event.keyCode === 88)
          // x
          socket.emit("keyPress", { inputId: "attack", state: true });
      };

      /**
       * When receiving the call, do one of the actions according to the event's value
       *  @param {event} event - key released event
       */
      document.onkeyup = function(event) {
        if (event.keyCode === 68)
          //d
          socket.emit("keyPress", { inputId: "right", state: false });
        else if (event.keyCode === 83)
          //s
          socket.emit("keyPress", { inputId: "down", state: false });
        else if (event.keyCode === 81)
          //q
          socket.emit("keyPress", { inputId: "left", state: false });
        else if (event.keyCode === 90)
          // z
          socket.emit("keyPress", { inputId: "up", state: false });
        else if (event.keyCode === 88)
          // x
          socket.emit("keyPress", { inputId: "attack", state: false });

        //user pressed and released enter key
        if (event.keyCode === 13) {
          if (!typing) {
            //user is not already typing, focus our chat text form
            chatInput.focus();
          } else {
            //user sent a message, unfocus our chat form
            chatInput.blur();
          }
        }
      };

      /**
       * Change the state of the user : either the user is writing on the chat or the user is playing
       */
      document.addEventListener("DOMContentLoaded", function() {
        document
          .getElementById("chat-input")
          .addEventListener("focus", function() {
            typing = true;
          });
        document
          .getElementById("chat-input")
          .addEventListener("blur", function() {
            typing = false;
          });
      });
    </script>
  </body>
</html>
